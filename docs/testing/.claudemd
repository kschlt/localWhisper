# Testing Context

This directory contains the test strategy, BDD feature seeds, and test infrastructure guidance.

---

## Files in This Directory

**Test Strategy:**
- `test-strategy.md` - Overall testing approach, test levels, tools

**BDD Seeds:**
- `bdd-feature-seeds.md` - BDD scenarios in Gherkin syntax (tagged by iteration)

**Test Infrastructure:**
- `test-infrastructure.md` - Test project setup, mocking, test data

---

## Testing Approach

**Test Pyramid:**
```
         /\
        /  \  Manual Testing (E2E, Usability)
       /____\
      /      \  Integration Tests (CLI adapters, file I/O)
     /________\
    /          \ Unit Tests (Core logic, state machine, slug)
   /____________\
```

**BDD (Behavior-Driven Development):**
- Primary acceptance testing mechanism
- Gherkin scenarios in `bdd-feature-seeds.md`
- Tagged by iteration, use case, requirement
- Implemented with SpecFlow (or similar)

---

## BDD Scenario Tags

**Tag Format:**
- `@Iter-{N}` - Iteration number (e.g., @Iter-1, @Iter-4)
- `@UC-{ID}` - Use case (e.g., @UC-001)
- `@FR-{ID}` - Functional requirement (e.g., @FR-010)
- `@NFR-{ID}` - Non-functional requirement (e.g., @NFR-001)

**Example:**
```gherkin
@Iter-1 @UC-001 @FR-010
Scenario: Hotkey toggles state to Recording
  Given the app is running in Idle state
  When the user presses the hotkey
  Then the state transitions to Recording
  And the tray icon shows recording indicator
  And the log contains "State: Idle → Recording"
```

---

## Test Execution by Iteration

### Iteration 1: Hotkey & Skeleton
**BDD Scenarios:**
- Hotkey toggles state (Idle ↔ Recording)
- Hotkey conflict detected
- Tray icon reflects state

**Unit Tests:**
- StateMachine: valid transitions
- StateMachine: invalid transitions throw

**Manual:**
- Hotkey works with other apps open
- Tray icon visible and responsive

---

### Iteration 2: Audio Recording
**BDD Scenarios:**
- Audio recording starts on hotkey down
- Recording stops on hotkey up
- WAV file created in tmp/

**Integration Tests:**
- AudioRecorder creates valid 16kHz mono WAV
- WAV file is deleted after processing

**Manual:**
- Record with different microphones
- Test with microphone access denied

---

### Iteration 3: STT Integration
**BDD Scenarios:**
- Whisper CLI invoked with correct parameters
- JSON output parsed correctly
- Timeout handled gracefully

**Integration Tests:**
- WhisperCLIAdapter with mock CLI executable
- Exit code handling (0, 1, 2, 3)

**Manual:**
- Measure STT latency (initial baseline)
- Test with various audio lengths

---

### Iteration 4: Clipboard + History + Flyout
**BDD Scenarios:**
- Transcript written to clipboard
- History file created with correct structure
- Flyout appears after clipboard write

**Integration Tests:**
- HistoryWriter creates valid Markdown
- SlugGenerator produces URL-safe slugs
- ClipboardService writes text correctly

**Performance Tests:**
- Measure p95 latency (NFR-001: ≤ 2.5s)
- Measure flyout latency (NFR-004: ≤ 0.5s)

**Manual:**
- E2E dictation flow (hold → speak → release → paste)
- Verify history file structure

---

### Iteration 5: Wizard + Repair
**BDD Scenarios:**
- Wizard completes successfully
- Model hash verification works
- Repair flow triggered when data root missing

**Integration Tests:**
- ModelManager: SHA-256 hash validation
- WizardWindow: input validation

**Manual:**
- Measure wizard completion time (NFR-004: < 2 min)
- Test wizard on fresh Windows VM
- Test repair flow by deleting data root

---

### Iteration 6: Settings
**BDD Scenarios:**
- Settings UI loads current config
- Changes saved to config.toml
- Hotkey updated without restart

**Integration Tests:**
- ConfigManager: TOML load/save
- ConfigManager: validation

**Manual:**
- Change each setting and verify persistence

---

### Iteration 7: Post-Processing
**BDD Scenarios:**
- LLM invoked when enabled
- Fallback to original transcript on error
- Post-processing can be disabled

**Integration Tests:**
- PostProcessorCLIAdapter with mock CLI

**Manual:**
- Test with real LLM
- Test with invalid LLM path

---

### Iteration 8: Stabilization + Reset
**BDD Scenarios:**
- Reset deletes data root
- Error matrix scenarios (all errors handled)
- No crashes in error conditions

**Integration Tests:**
- ResetService deletes all files
- Error handling for all components

**Performance Tests:**
- Re-measure p95 latency (final)
- Memory footprint (NFR: < 150 MB idle)

**Manual:**
- Full error matrix testing
- Long-running stability test

---

## Running Tests

**BDD scenarios for specific iteration:**
```bash
dotnet test --filter "Category=Iter-3"
```

**BDD scenarios for specific requirement:**
```bash
dotnet test --filter "Category=FR-010"
```

**All unit tests:**
```bash
dotnet test --filter "Category=Unit"
```

**All integration tests:**
```bash
dotnet test --filter "Category=Integration"
```

**All tests (regression):**
```bash
dotnet test
```

---

## BDD Scenario Structure

**Standard template:**
```gherkin
@Iter-{N} @UC-{ID} @FR-{ID}
Scenario: {Brief description}
  Given {initial state/context}
  When {action/trigger}
  Then {expected outcome}
  And {additional verification}
  And {log/metric verification}
```

**Example (Iteration 3):**
```gherkin
@Iter-3 @UC-001 @FR-012
Scenario: Whisper CLI produces valid JSON
  Given a 5-second WAV file exists in tmp/
  When WhisperCLIAdapter invokes whisper-cli.exe
  Then stt_result.json is created
  And the JSON contains "text", "language", "duration_sec" fields
  And the adapter returns a transcript object
```

---

## Test Data

**Audio samples:**
- `tests/TestData/audio/5sec-silence.wav` - Silent audio
- `tests/TestData/audio/5sec-speech.wav` - Sample dictation
- `tests/TestData/audio/invalid.wav` - Corrupted file

**Config samples:**
- `tests/TestData/config/valid.toml` - Valid configuration
- `tests/TestData/config/missing-fields.toml` - Incomplete config
- `tests/TestData/config/invalid-hotkey.toml` - Invalid hotkey

**CLI mock responses:**
- `tests/TestData/cli/whisper-success.json` - Valid STT result
- `tests/TestData/cli/whisper-error.json` - Error response

**See:** `test-infrastructure.md` for setup details

---

## Mocking & Test Doubles

**Mock external dependencies:**
- `IWhisperCLIAdapter` - Mock for Whisper invocation
- `IAudioRecorder` - Mock for audio capture
- `IClipboardService` - Mock for clipboard write
- `IFilesystem` - Mock for file I/O

**Test doubles for BDD:**
- Mock CLI executables (return predefined JSON)
- Stub audio devices (return test WAV)
- Fake clipboard (verify write calls)

**See:** `test-infrastructure.md` for implementation

---

## Performance Testing

### NFR-001: E2E Latency (p95 ≤ 2.5s)

**When to test:**
- Iteration 4 (initial baseline)
- Iteration 8 (final verification)

**How to test:**
1. Record 100 dictations (5-10 seconds each)
2. Measure time: hotkey up → clipboard ready
3. Calculate p50, p95, p99 percentiles
4. Document in changelog

**Target:**
- p95 ≤ 2.5s (MUST pass)
- p50 ~ 1.5s (ideal)

---

### NFR-004: Flyout Latency (≤ 0.5s)

**When to test:**
- Iteration 4

**How to test:**
1. Measure time: clipboard write → flyout visible
2. Repeat 50 times
3. Calculate average and p95

**Target:**
- Average ≤ 0.5s

---

### NFR-004: Wizard Completion (< 2 min)

**When to test:**
- Iteration 5

**How to test:**
1. Fresh Windows VM
2. Run wizard (default path)
3. Measure time: launch → wizard complete
4. Repeat 5 times

**Target:**
- Average < 2 min

---

## Manual Testing Checklists

### Iteration 1: Hotkey & Skeleton
- [ ] Hotkey works with various apps in focus
- [ ] Tray icon appears in system tray
- [ ] Context menu shows all expected items
- [ ] App exits cleanly
- [ ] Logs are written to correct location

### Iteration 4: E2E Flow
- [ ] Hold hotkey → speak → release → text appears in clipboard
- [ ] Paste into Notepad → text is correct
- [ ] History file created in correct location
- [ ] Flyout appears with correct message
- [ ] Multiple dictations work consecutively

### Iteration 8: Error Matrix
- [ ] Microphone denied → dialog shows clear message
- [ ] Model missing → repair wizard triggered
- [ ] Hotkey conflict → error dialog, app stable
- [ ] Disk full → error dialog, app stable
- [ ] STT timeout → error dialog, audio preserved

---

## Error Matrix Testing (Iteration 8)

**Test every error scenario:**

| Error Condition | Expected Behavior | Verified |
|-----------------|-------------------|----------|
| Microphone access denied | Dialog with instructions, app stable | [ ] |
| Model file missing | Repair wizard triggered | [ ] |
| Model hash mismatch | Repair wizard triggered | [ ] |
| Hotkey conflict | Dialog to choose new hotkey | [ ] |
| Disk full (tmp/) | Error dialog, graceful degradation | [ ] |
| Disk full (history/) | Error dialog, clipboard still works | [ ] |
| STT timeout | Error dialog, audio file preserved | [ ] |
| Invalid config.toml | Reset to defaults, log warning | [ ] |
| Whisper CLI missing | Error dialog, repair wizard | [ ] |

**No crashes allowed.** All scenarios must be handled gracefully per FR-021.

---

## Test Coverage Targets

**Code coverage:**
- Core components: 80%+ (StateMachine, ConfigManager, SlugGenerator)
- Services: 70%+ (HotkeyManager, AudioRecorder, HistoryWriter)
- Adapters: 60%+ (WhisperCLIAdapter, PostProcessorCLIAdapter)
- UI: 40%+ (Manual testing primary)

**BDD coverage:**
- All US-### acceptance criteria covered by at least one scenario
- All FR-### functional requirements tested

**NFR coverage:**
- All measurable NFRs verified in relevant iterations

---

## Common Testing Patterns

**Test a state transition:**
```csharp
[Fact]
public void StateMachine_TransitionsFromIdleToRecording() {
    var sm = new StateMachine();
    sm.Transition(AppState.Recording);
    Assert.Equal(AppState.Recording, sm.CurrentState);
}
```

**Test BDD scenario:**
```csharp
[Given(@"the app is running in Idle state")]
public void GivenAppInIdle() {
    _context.StateMachine = new StateMachine();
}

[When(@"the user presses the hotkey")]
public void WhenHotkeyPressed() {
    _context.StateMachine.Transition(AppState.Recording);
}

[Then(@"the state transitions to Recording")]
public void ThenStateIsRecording() {
    Assert.Equal(AppState.Recording, _context.StateMachine.CurrentState);
}
```

**Test CLI adapter (mocked):**
```csharp
[Fact]
public async Task WhisperAdapter_ReturnsTranscript() {
    var mockProcess = new MockProcess("whisper-success.json");
    var adapter = new WhisperCLIAdapter(mockProcess);
    var result = await adapter.TranscribeAsync("test.wav");
    Assert.NotNull(result.Text);
}
```

---

## Anti-Patterns (Avoid These)

❌ **Skipping BDD scenarios:**
- Every iteration has tagged scenarios - run them!

❌ **No regression testing:**
- Run ALL previous iteration tests, not just current

❌ **Manual-only testing:**
- Automate acceptance criteria with BDD

❌ **Ignoring NFR verification:**
- Measure performance targets (p95, flyout latency, etc.)

❌ **Weak error testing:**
- Test full error matrix (Iteration 8)

---

## Test Infrastructure Setup

**See:** `test-infrastructure.md` for:
- Project structure (`tests/Unit`, `tests/Integration`, `tests/Features`)
- SpecFlow configuration
- Mock/stub implementations
- Test data organization
- CI/CD integration

---

## Related Context Files

- **Requirements:** `docs/specification/.claudemd`
- **Architecture:** `docs/architecture/.claudemd`
- **Iterations:** `docs/iterations/.claudemd`

---

**Last Updated:** 2025-11-17
**Test Framework:** xUnit + SpecFlow (BDD)
**Status:** Test strategy complete, ready for implementation
