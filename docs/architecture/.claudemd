# Architecture Context

This directory contains the system design and architectural decisions for Dictate-to-Clipboard.

---

## Files in This Directory

**System Design:**
- `architecture-overview.md` - Components, layers, technology stack
- `runtime-flows.md` - End-to-end sequence diagrams
- `interface-contracts.md` - CLI contracts (Whisper, LLM)
- `implementation-details.md` - Specific implementation guidance
- `risk-register.md` - Risks, impacts, mitigations

**Architecture Decision Records (ADRs):**
- Located in `docs/adr/` directory
- Numbered sequentially: ADR-0001, ADR-0002, etc.
- See: `docs/adr/0000-index.md` for summary

---

## Architecture at a Glance

**Style:** Layered architecture with service-oriented components

**Layers:**
```
┌─────────────────────────────────────────┐
│ Presentation (Tray, Wizard, Settings)  │
├─────────────────────────────────────────┤
│ Services (Hotkey, Audio, Clipboard)    │
├─────────────────────────────────────────┤
│ Adapters (Whisper CLI, LLM CLI)        │
├─────────────────────────────────────────┤
│ Core (State Machine, Config, Logger)   │
├─────────────────────────────────────────┤
│ Infrastructure (Filesystem, Win32)     │
└─────────────────────────────────────────┘
```

**Communication:**
- Synchronous method calls within layers
- Event-driven for state changes
- Process I/O (stdin/stdout) for CLI adapters

---

## Key Components

**Presentation Layer:**
- `TrayApp` - Main entry point, tray icon, lifecycle
- `WizardWindow` - First-run setup (3 steps)
- `SettingsWindow` - Configuration UI
- `FlyoutNotification` - Custom notification (not Windows toast)
- `ErrorDialogs` - User-friendly error messages

**Application Services:**
- `HotkeyManager` - Global hotkey registration (Win32 API)
- `AudioRecorder` - WASAPI recording → WAV file
- `ClipboardService` - System clipboard write
- `HistoryWriter` - Markdown/TXT file creation
- `ModelManager` - SHA-256 hash verification
- `ResetService` - Data root deletion

**Adapters:**
- `WhisperCLIAdapter` - Invokes whisper-cli.exe, parses JSON
- `PostProcessorCLIAdapter` - Invokes LLM CLI (optional)

**Core:**
- `StateMachine` - Idle ↔ Recording ↔ Processing
- `ConfigManager` - Load/save TOML configuration
- `AppLogger` - Structured logging, rotation at 10 MB
- `SlugGenerator` - URL-safe filename from transcript

---

## Critical Data Flow (E2E Dictation)

```
User holds hotkey
  → HotkeyManager fires OnHotkeyDown event
  → StateMachine transitions Idle → Recording
  → AudioRecorder starts capturing (WASAPI)

User releases hotkey
  → HotkeyManager fires OnHotkeyUp event
  → AudioRecorder stops, saves WAV to tmp/
  → StateMachine transitions Recording → Processing
  → WhisperCLIAdapter invokes whisper-cli.exe with WAV path
  → Whisper returns JSON with transcript text
  → ClipboardService writes text to clipboard
  → HistoryWriter saves Markdown file
  → FlyoutNotification displays "Transcript in clipboard"
  → StateMachine transitions Processing → Idle
```

**See:** `runtime-flows.md` for detailed sequence diagrams

---

## Architecture Decision Records (ADRs)

**ADR-0001: Platform = .NET 8 + WPF**
- Rationale: Fast development, Windows-native, portable EXE
- Impact: Must use Windows APIs, no cross-platform

**ADR-0002: CLI Subprocesses (not FFI)**
- Rationale: Easier debugging, model swapping, timeout handling
- Impact: Must define CLI contracts (JSON I/O)

**ADR-0003: Single Data Root Folder**
- Rationale: Easy backup, migration, reset
- Impact: All data in one location (config, models, history, logs)

**ADR-0004: Autostart Removed**
- Rationale: No admin rights, no installer, user can use Task Scheduler
- Impact: Manual workaround documented

**ADR-0005: Custom Flyout (not Windows Toast)**
- Rationale: More reliable, faster, customizable
- Impact: Must implement custom WPF window

**See:** `docs/adr/0000-index.md` for full list and details

---

## Interface Contracts

### Whisper CLI Contract

**Invocation:**
```bash
whisper-cli.exe \
  --model "models/whisper-base.bin" \
  --language "de" \
  --input "tmp/20250917_143022.wav" \
  --output "tmp/20250917_143022_result.json"
```

**Output JSON (stt_result.json):**
```json
{
  "text": "Let me check on that and get back to you tomorrow morning",
  "language": "en",
  "duration_sec": 4.2
}
```

**Exit Codes:**
- 0: Success
- 1: File not found
- 2: Model error
- 3: Timeout

**Timeout:** 60 seconds default (configurable)

### LLM CLI Contract (Optional Post-Processing)

**Invocation:**
```bash
llm-cli.exe --mode format --input - --output -
```

**Input (stdin):**
```
raw transcript from whisper
```

**Output (stdout):**
```
Formatted transcript with corrections
```

**Fallback:** If LLM fails, use original transcript

**See:** `interface-contracts.md` for complete specifications

---

## Technology Stack

| Component | Technology |
|-----------|------------|
| Platform | .NET 8 (C#) |
| UI Framework | WPF |
| Audio | WASAPI (via NAudio or P/Invoke) |
| STT | Whisper (external CLI tool) |
| Post-Processing | LLM CLI (optional, user-provided) |
| Config | TOML (via Tomlyn library) |
| Logging | Serilog or NLog |
| Testing | xUnit, SpecFlow (BDD) |
| Build | .NET CLI, Self-Contained Publish |

---

## Design Principles

**1. Separation of Concerns**
- UI layer has no business logic
- Adapters encapsulate external tool invocation
- Core components testable in isolation

**2. Fail-Safe Defaults**
- Critical path (clipboard) succeeds even if secondary ops fail
- Errors logged but don't block workflow

**3. Explicit State Management**
- State machine enforces valid transitions
- All state changes logged
- UI reflects current state

**4. Testability**
- Services use interfaces (mockable)
- CLI adapters replaceable with test doubles
- BDD scenarios drive acceptance tests

**5. Observability First**
- Every significant event logged
- Structured logging (key-value pairs)
- Performance metrics instrumented

---

## Data Root Structure

```
<DATA_ROOT>/
  config/
    config.toml           ← Settings (hotkey, language, etc.)

  models/
    whisper-base.bin      ← STT model file
    whisper-base.sha256   ← Hash for verification

  history/
    2025/
      2025-09/
        2025-09-17/
          20250917_143022_let-me-check.md
          20250917_150133_another-dictation.md

  logs/
    app.log               ← Structured logs (rotated at 10 MB)

  tmp/
    20250917_143022.wav   ← Temporary audio (auto-cleaned)
```

**See:** ADR-0003, `docs/specification/data-structures.md`

---

## Performance Targets

| Metric | Target | Architecture Impact |
|--------|--------|---------------------|
| E2E Latency | p95 ≤ 2.5s | Parallel clipboard + history writes |
| Flyout Latency | ≤ 0.5s | Custom WPF window, not toast |
| Startup Time | < 3s | Lazy initialization, no blocking I/O |
| Memory (idle) | < 150 MB | Dispose audio resources promptly |

**Verified in:** Iteration 4 (initial), Iteration 8 (final)

---

## Security & Privacy

**Data Privacy:**
- All processing offline (no cloud)
- No telemetry by default
- Logs don't contain transcript text

**Trust & Signing:**
- v0.1: No code signing (SmartScreen warnings accepted)
- Future: Code signing certificate

**Permissions:**
- No admin rights required
- Microphone access via standard Windows permissions
- User-writable folders only

---

## Error Handling Strategy

**Per FR-021:**
- All errors caught and logged
- User-friendly dialogs (no stack traces)
- App remains stable (no crashes)

**Error Categories:**
1. **Microphone access denied** → Dialog with instructions
2. **Model file missing/corrupted** → Repair wizard
3. **Hotkey conflict** → Dialog to choose different hotkey
4. **Disk full** → Dialog, graceful degradation
5. **STT timeout** → Dialog, preserve audio file for retry

**See:** `risk-register.md` for full error matrix

---

## Scalability & Limits

**Current Design Limits (v0.1):**
- Single concurrent dictation (no queueing)
- Audio limited to ~10 minutes (Whisper timeout)
- No built-in history search UI
- Manual model management

**Future Enhancements:**
- Queue for overlapping dictations
- In-app history search
- Auto-update for app and models

---

## Common Architecture Queries

**How does hotkey registration work?**
→ Read: `architecture-overview.md` (HotkeyManager section)
→ Read: `docs/adr/0001-platform-dotnet-wpf.md` (Win32 API usage)

**How is Whisper invoked?**
→ Read: `interface-contracts.md` (Whisper CLI contract)
→ Read: `docs/adr/0002-cli-subprocesses.md` (CLI vs FFI decision)

**What's the data root structure?**
→ Read: `docs/specification/data-structures.md`
→ Read: `docs/adr/0003-storage-layout.md`

**How are errors handled?**
→ Read: `risk-register.md`
→ Read: `docs/specification/functional-requirements.md` (FR-021)

**How is state managed?**
→ Read: `architecture-overview.md` (StateMachine section)
→ Read: `runtime-flows.md` (state transitions)

---

## Implementation Guidance

**Before implementing a component:**

1. **Check ADR constraints:**
   - Read relevant ADRs (e.g., ADR-0002 for CLI adapters)
   - Note architectural decisions that impact design

2. **Check interface contracts:**
   - If working with CLI adapters, read `interface-contracts.md`
   - Understand JSON formats, exit codes, timeouts

3. **Check data structures:**
   - If reading/writing files, check `docs/specification/data-structures.md`
   - Understand folder structure, file formats

4. **Check runtime flows:**
   - Read `runtime-flows.md` for end-to-end sequences
   - Understand event ordering, state transitions

5. **Implement with observability:**
   - Add structured logging for key operations
   - Log state transitions, errors, performance metrics

---

## Anti-Patterns (Avoid These)

❌ **Violating ADR constraints:**
- Don't use FFI for Whisper (ADR-0002: use CLI)
- Don't scatter data files (ADR-0003: single root)

❌ **Changing interface contracts without updating docs:**
- If JSON format changes, update `interface-contracts.md`

❌ **Bypassing state machine:**
- All state transitions must go through StateMachine
- Don't set state directly in UI

❌ **Blocking the UI thread:**
- Audio recording, STT invocation must be async
- Use Task/async-await patterns

---

## Related Context Files

- **Requirements:** `docs/specification/.claudemd`
- **Iterations:** `docs/iterations/.claudemd`
- **Testing:** `docs/testing/.claudemd`

---

**Last Updated:** 2025-11-17
**Architecture Version:** v0.1 (stable)
**Status:** Complete, ready for implementation
